(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{extend:()=>st});const s=flarum.core.compat["forum/app"];var n=t.n(s);const r=flarum.core.compat["common/extend"],a=flarum.core.compat["common/components/Button"];var o=t.n(a);const i=flarum.core.compat["forum/components/SettingsPage"];var u=t.n(i);function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}function l(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}const d=flarum.core.compat["common/utils/Stream"];var h=t.n(d);const p=flarum.core.compat["common/components/Modal"];var f=t.n(p),q=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.username=h()(this.attrs.nickname?n().session.user.displayName():n().session.user.username()),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.lastRequest=n().session.user[this.userRequestAttr](),this.lastRequest&&this.username(this.lastRequest.requestedUsername()),this.success=!1,this.password=h()(""),this.translationPrefix="fof-username-request.forum."+(this.attrs.nickname?"nickname":"username")+"_modals.request"},s.className=function(){return"RequestUsernameModal Modal--small"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.content=function(){return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".confirmation_message")),m("div",{className:"Form-group"},m(o(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},n().translator.trans(this.translationPrefix+".dismiss_button"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.lastRequest?m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".current_request",{name:this.lastRequest.requestedUsername()})):"",m("div",{className:"Form-group"},m("input",{type:"text",name:"text",className:"FormControl",placeholder:n().session.user.username(),bidi:this.username,disabled:this.deleteLoading||this.submitLoading})),n().forum.attribute("passwordlessSignUp")?null:m("div",{className:"Form-group"},m("input",{type:"password",name:"password",className:"FormControl",placeholder:n().translator.trans("core.forum.change_email.confirm_password_placeholder"),bidi:this.password,disabled:this.deleteLoading||this.submitLoading})),m("div",{className:"Form-group"},o().component({className:"Button Button--primary Button--block",type:"submit",loading:this.submitLoading},n().translator.trans(this.translationPrefix+".submit_button"))),this.lastRequest?m("div",{className:"Form-group"},o().component({className:"Button Button--primary Button--block",onclick:this.deleteRequest.bind(this),loading:this.deleteLoading},n().translator.trans(this.translationPrefix+".delete_button"))):""))},s.deleteRequest=function(t){t.preventDefault(),this.deleteLoading=!0,this.lastRequest.delete(),this.successAlert=n().alerts.show({type:"success"},n().translator.trans(this.translationPrefix+".deleted")),n().session.user[this.userRequestAttr]=h()(),this.hide()},s.onsubmit=function(t){var e=this;t.preventDefault(),this.alert=null;var s=this.attrs.nickname?n().session.user.displayName():n().session.user.username();this.username()!==s?(this.submitLoading=!0,n().store.createRecord("username-requests").save({username:this.username(),forNickname:this.attrs.nickname},{meta:{password:this.password()},errorHandler:this.onerror.bind(this)}).then(function(t){n().session.user[e.userRequestAttr]=h()(t),e.success=!0,e.alertAttrs=null}).catch(function(){}).then(this.loaded.bind(this))):this.hide()},s.onerror=function(e){401===e.status&&(e.alert.content=n().translator.trans("core.forum.change_email.incorrect_password_message"),this.submitLoading=!1),t.prototype.onerror.call(this,e)},e}(f());const v=flarum.core.compat["forum/components/HeaderSecondary"];var N=t.n(v);const b=flarum.core.compat["forum/components/NotificationsDropdown"];var y=t.n(b);const g=flarum.core.compat["common/Component"];var _=t.n(g);const k=flarum.core.compat["common/components/LoadingIndicator"];var x=t.n(k);const R=flarum.core.compat["common/helpers/avatar"];var w=t.n(R);const P=flarum.core.compat["common/helpers/username"];var A=t.n(P);const U=flarum.core.compat["common/helpers/icon"];var B=t.n(U);const F=flarum.core.compat["common/helpers/humanTime"];var M=t.n(F);const L=flarum.core.compat["common/utils/withAttr"];var j=t.n(L),O=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.request=this.attrs.request,this.approved=h()("Rejected"),this.reason=h()(""),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.action"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.className=function(){return"RequestActionModal Modal--medium"},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("h3",{className:"Notification-content"},n().translator.trans(this.translationPrefix+".name",{name:A()(this.request.user()),requestedName:this.request.requestedUsername()})),m("p",{className:"help"},n().translator.trans(this.translationPrefix+".help_text")),m("legend",null,n().translator.trans(this.translationPrefix+".decision_title")),m("div",{className:"Form-group"},m("label",{className:"checkbox"},m("input",{type:"radio",name:"approved",value:"Approved",checked:"Approved"===this.approved(),onclick:j()("value",this.approved)}),n().translator.trans(this.translationPrefix+".approval_label")),m("label",{className:"checkbox"},m("input",{type:"radio",name:"rejected",value:"Rejected",checked:"Rejected"===this.approved(),onclick:j()("value",this.approved)}),n().translator.trans(this.translationPrefix+".rejected_label"))),"Rejected"===this.approved()?m("div",{className:"Form-group"},m("legend",null,n().translator.trans(this.translationPrefix+".reason_title")),m("div",{className:"BasicsPage-reason-input"},m("textarea",{className:"FormControl",value:this.reason(),disabled:this.loading,oninput:j()("value",this.reason)}))):"",m("div",{className:"Form-group"},o().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:"Rejected"===this.approved()&&!this.reason()},n().translator.trans(this.translationPrefix+".submit_button")))))},s.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0,this.request.save({reason:this.reason(),action:this.approved()}).then(function(){e.successAlert=n().alerts.show({type:"success"},n().translator.trans(e.translationPrefix+".success"))}),n().cache.username_requests.some(function(t,s){t.id()==e.request.id()&&n().cache.username_requests.splice(s,1)}),m.redraw(),this.hide()},e}(f()),S=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!1},s.view=function(){var t=this,e=n().cache.username_requests||[];return m("div",{className:"NotificationList RequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},n().translator.trans("fof-username-request.forum.pending_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},e.length?e.map(function(e){var s=e.forNickname()?"nickname":"username";return m("li",null,m("a",{onclick:t.showModal.bind(t,e),className:"Notification Request"},w()(e.user()),B()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},n().translator.trans("fof-username-request.forum.pending_requests."+s+"_item_text",{name:A()(e.user())})),M()(e.createdAt()),m("div",{className:"Notification-excerpt"},n().translator.trans("fof-username-request.forum.pending_requests."+s+"_exerpt",{requestedName:e.requestedUsername()}))))}):this.loading?x().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},n().translator.trans("fof-username-request.forum.pending_requests.empty_text")))))},s.showModal=function(t){n().modal.show(O,{request:t})},e}(_()),C=function(t){function e(){return t.apply(this,arguments)||this}l(e,t),e.initAttrs=function(e){e.label=e.label||n().translator.trans("fof-username-request.forum.pending_requests.tooltip"),e.icon=e.icon||"fas fa-user-edit",t.initAttrs.call(this,e)};var s=e.prototype;return s.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?S.component({state:n().usernameRequests}):"")},s.goToRoute=function(){m.route.set(n().route("username_requests"))},s.getUnreadCount=function(){return n().cache.username_requests?n().cache.username_requests.length:n().forum.data.relationships.username_requests.data.length},s.getNewCount=function(){return n().cache.username_requests?n().cache.username_requests.length:n().forum.data.relationships.username_requests.data.length},e}(y()),T=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.request=n().session.user[this.userRequestAttr](),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.results"},s.className=function(){return"ResultsModal Modal"},s.title=function(){return n().translator.trans(this.translationPrefix+".title")},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},"Approved"===this.request.status()?[m("h2",null,n().translator.trans(this.translationPrefix+".approved")),m("h3",null,n().translator.trans(this.translationPrefix+".new_name",{name:n().session.user.displayName()}))]:[m("h2",null,n().translator.trans(this.translationPrefix+".rejected")),m("h3",null,n().translator.trans(this.translationPrefix+".reason",{reason:this.request.reason(),i:m("i",null)})),m("p",{className:"helpText"},n().translator.trans(this.translationPrefix+".resubmit"))],m("div",{className:"Form-group"},m(o(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},n().translator.trans(this.translationPrefix+".dismiss_button")))))},s.onremove=function(){n().session.user[this.userRequestAttr]=h()(),this.request.save({delete:!0})},e}(f());const D=flarum.core.compat["common/components/LinkButton"];var H=t.n(D);const I=flarum.core.compat["forum/components/UserPage"];var G=t.n(I),z=function(){function t(t){this.app=t,this.loading=!1,this.cache=[]}return t.prototype.load=function(){var t=this;n().cache.username_requests||(this.loading=!0,m.redraw(),n().store.find("username-requests").then(function(t){delete t.payload,n().cache.username_requests=t.sort(function(t,e){return t.createdAt()-e.createdAt()})}).catch(function(){}).then(function(){t.loading=!1,m.redraw()}))},t}();const E=flarum.core.compat["common/extenders"];var J=t.n(E);const K=flarum.core.compat["common/models/User"];var Q=t.n(K);const V=flarum.core.compat["common/Model"];var W=t.n(V);const X=flarum.core.compat["common/utils/computed"];var Y=t.n(X),Z=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.user=function(){return W().hasOne("user").call(this)},s.status=function(){return W().attribute("status").call(this)},s.reason=function(){return W().attribute("reason").call(this)},s.createdAt=function(){return W().attribute("createdAt",W().transformDate).call(this)},s.forNickname=function(){return W().attribute("forNickname").call(this)},s._requestedUsername=function(){return W().attribute("requestedUsername").call(this)},s.requestedUsername=function(){return Y()("_requestedUsername","forNickname","user",function(t,e,s){return null===t&&e?s.username():t}).call(this)},e}(W());const $=flarum.core.compat["common/components/Page"];var tt=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),n().history.push("requests"),n().usernameRequests.load(),this.bodyClass="App--requests"},s.view=function(){return m("div",{className:"RequestsPage"},m(S,{state:n().usernameRequests}))},e}(t.n($)()),et=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!0,this.loadUser(m.route.param("username"))},s.content=function(){var t=this;return m("table",{className:"NotificationGrid"},this.user.usernameHistory().slice(0).reverse().map(function(e){var s=Object.keys(e)[0];return m("tr",null,m("td",null,s),m("td",null,M()(t.calculateTime(e[s]))))}))},s.show=function(t){this.user=t,m.redraw()},s.calculateTime=function(t){return new Date(0).setUTCSeconds(t)},e}(G());const st=[(new(J().Routes)).add("username_requests","/username-requests",tt).add("username_history","/u/:username/history",et),(new(J().Store)).add("username-requests",Z),new(J().Model)(Q()).hasOne("lastNicknameRequest").hasOne("lastUsernameRequest").attribute("usernameHistory")];n().initializers.add("fof-username-request",function(){n().usernameRequests=new z(n()),(0,r.extend)(u().prototype,"accountItems",function(t){n().forum.attribute("canRequestUsername")&&t.add("username-request",o().component({className:"Button",onclick:function(){n().modal.show(q)}},n().translator.trans("fof-username-request.forum.settings.username_request_button")),8),"nickname"===n().forum.attribute("displayNameDriver")&&n().forum.attribute("canRequestNickname")&&!this.user.attribute("canEditOwnNickname")&&"flarum-nicknames"in flarum.extensions&&t.add("nickname-request",o().component({className:"Button",onclick:function(){n().modal.show(q,{nickname:!0})}},n().translator.trans("fof-username-request.forum.settings.nickname_request_button")),8)}),(0,r.extend)(N().prototype,"items",function(t){(n().forum.data.relationships.username_requests&&n().forum.data.relationships.username_requests.data.length&&!n().cache.username_requests||n().cache.username_requests&&0!==n().cache.username_requests.length)&&t.add("UsernameRequests",m(C,{state:n().usernameRequests}),20)}),new Promise(function(){setTimeout(function(){if(n().session.user){var t=n().session.user.lastNicknameRequest()&&"Sent"!==n().session.user.lastNicknameRequest().status(),e=n().session.user.lastUsernameRequest()&&"Sent"!==n().session.user.lastUsernameRequest().status();(t||e)&&n().modal.show(T,{nickname:t})}},1e3)}),(0,r.extend)(G().prototype,"navItems",function(t){this.user.usernameHistory()&&t.add("username-requests",H().component({href:n().route("username_history",{username:this.user.slug()}),icon:"fas fa-user-edit"},n().translator.trans("fof-username-request.forum.user.name_history_link")))})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map